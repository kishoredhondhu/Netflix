/*
This immersive contains the Angular frontend code, updated to work with a backend
that provides GET /api/v1/projects/{id}.
BudgetManagementComponent and TeamManagementComponent will now fetch and display project titles.
*/

// =============== src/app/models/budget.model.ts ===============
export enum ContractStatus {
    DRAFT = 'DRAFT',
    SENT = 'SENT',
    SIGNED = 'SIGNED',
    ACTIVE = 'ACTIVE',
    COMPLETED = 'COMPLETED',
    EXPIRED = 'EXPIRED',
    TERMINATED = 'TERMINATED'
}

export interface CreateBudgetRequestDto {
  movieProjectId: number;
  totalAllocatedAmount: number;
  currency: string;
}

export interface BudgetDto {
  id: number;
  movieProjectId: number;
  movieProjectTitle?: string;
  totalAllocatedAmount: number;
  currency: string;
  version: number;
  createdAt: string;
  updatedAt: string;
  categories: BudgetCategoryDto[];
}

export interface CreateBudgetCategoryRequestDto {
  name: string;
  allocatedAmount: number;
}

export interface BudgetCategoryDto {
  id: number;
  name: string;
  allocatedAmount: number;
  lineItems: BudgetLineItemDto[];
}

export interface CreateBudgetLineItemRequestDto {
  description: string;
  estimatedCost: number;
  notes?: string;
}

export interface BudgetLineItemDto {
  id: number;
  description: string;
  estimatedCost: number;
  actualCost?: number;
  notes?: string;
}

// =============== src/app/models/project.model.ts ===============
export interface CreateMovieProjectRequest {
  title: string;
  genre: string;
  budget: number | null;
  startDate: string | null;
  endDate: string | null;
  keyTeamMembersInfo: string;
  startFromScratch: boolean;
}

export interface MovieProjectResponse {
  id: number;
  title: string;
  genre: string;
  budget: number;
  startDate: string;
  endDate: string;
  keyTeamMembersInfo: string;
  startedFromScratch: boolean;
  createdAt: string;
  updatedAt: string;
  projectDashboardStatus: string;
}

// =============== src/app/models/team.model.ts ===============
export enum TeamMemberType {
    CAST = 'CAST',
    CREW = 'CREW'
}

export interface CreateTeamMemberRequestDto {
    projectId: number;
    name: string;
    role: string;
    type: TeamMemberType;
    contactInfo: string;
    department?: string;
    agentInfo?: string;
    contractDetails?: string;
    availabilityNotes?: string;
}

export interface TeamMemberDto {
    id: number;
    projectId: number;
    name: string;
    role: string;
    type: TeamMemberType;
    contactInfo: string;
    department?: string;
    agentInfo?: string;
    contractDetails?: string;
    availabilityNotes?: string;
    createdAt: string;
    updatedAt: string;
}


// =============== src/app/services/budget.service.ts ===============
// (No changes from previous version, assumed to be correctly calling backend budget endpoints)
import { Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError, of, timer } from 'rxjs';
import { catchError, timeout, switchMap } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class BudgetService {
  private budgetsApiUrl = 'http://localhost:8081/api/v1/budgets';
  private readonly REQUEST_TIMEOUT = 30000;

  constructor(private http: HttpClient) { }

  createBudgetForProject(data: CreateBudgetRequestDto): Observable<BudgetDto> {
    console.log('BudgetService: createBudgetForProject called with data:', data);
    return this.http.post<BudgetDto>(`${this.budgetsApiUrl}/project`, data)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error('BudgetService: createBudgetForProject request timed out.');
            return throwError(() => new Error('Request to create budget timed out. Please try again.'));
          }
          return this.handleError(err, 'createBudgetForProject');
        })
      );
  }

  getBudgetById(budgetId: number): Observable<BudgetDto> {
    console.log(`BudgetService: getBudgetById called for budgetId: ${budgetId}`);
    return this.http.get<BudgetDto>(`${this.budgetsApiUrl}/${budgetId}`)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error(`BudgetService: getBudgetById request for ${budgetId} timed out.`);
            return throwError(() => new Error(`Request to get budget ${budgetId} timed out.`));
          }
          return this.handleError(err, `getBudgetById(${budgetId})`);
        })
      );
  }

  getBudgetByMovieProjectId(movieProjectId: number): Observable<BudgetDto | null> {
    console.log(`BudgetService: getBudgetByMovieProjectId called for movieProjectId: ${movieProjectId}`);
    return this.http.get<BudgetDto>(`${this.budgetsApiUrl}/project/${movieProjectId}`).pipe(
      timeout(this.REQUEST_TIMEOUT),
      catchError(error => {
        if (error.name === 'TimeoutError') {
          console.error(`BudgetService: getBudgetByMovieProjectId request for ${movieProjectId} timed out.`);
          return throwError(() => new Error(`Request to get budget for project ${movieProjectId} timed out.`));
        }
        if (error.status === 404) {
          console.log(`BudgetService: No budget found for movieProjectId: ${movieProjectId}`);
          return of(null);
        }
        return this.handleError(error, `getBudgetByMovieProjectId(${movieProjectId})`);
      })
    );
  }

  addCategoryToBudget(budgetId: number, categoryData: CreateBudgetCategoryRequestDto): Observable<BudgetCategoryDto> {
    console.log(`BudgetService: addCategoryToBudget called for budgetId: ${budgetId} with data:`, categoryData);
    return this.http.post<BudgetCategoryDto>(`${this.budgetsApiUrl}/${budgetId}/categories`, categoryData)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error(`BudgetService: addCategoryToBudget request for budget ${budgetId} timed out.`);
            return throwError(() => new Error(`Request to add category to budget ${budgetId} timed out.`));
          }
          return this.handleError(err, `addCategoryToBudget(budget ${budgetId})`);
        })
      );
  }

  addLineItemToCategory(categoryId: number, lineItemData: CreateBudgetLineItemRequestDto): Observable<BudgetLineItemDto> {
    console.log(`BudgetService: addLineItemToCategory called for categoryId: ${categoryId} with data:`, lineItemData);
    return this.http.post<BudgetLineItemDto>(`${this.budgetsApiUrl}/categories/${categoryId}/lineitems`, lineItemData)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error(`BudgetService: addLineItemToCategory request for category ${categoryId} timed out.`);
            return throwError(() => new Error(`Request to add line item to category ${categoryId} timed out.`));
          }
          return this.handleError(err, `addLineItemToCategory(category ${categoryId})`);
        })
      );
  }

  private handleError(error: HttpErrorResponse, operation: string = 'operation') {
    let errorMessage = `An unknown error occurred during ${operation}!`;
    if (error.status === 0) {
        errorMessage = `Network error or CORS issue during ${operation}. Could not connect to the backend or request was blocked. Please check backend server and CORS configuration.`;
    } else if (error.error instanceof ErrorEvent) {
      errorMessage = `Client-side/Network error during ${operation}: ${error.error.message}`;
    } else {
      errorMessage = `Backend error during ${operation}. Code: ${error.status}, Message: "${error.message || error.statusText}"`;
      if (error.error && typeof error.error === 'object' && error.error.message) {
         errorMessage += ` Details: ${error.error.message}`;
      } else if (typeof error.error === 'string' && error.error.length < 200 && error.error.length > 0) {
         errorMessage += ` Server Error: ${error.error}`;
      }
    }
    console.error(`BudgetService Error: ${operation} failed (full details):`, { message: errorMessage, errorObj: error });
    return throwError(() => new Error(errorMessage));
  }
}

// =============== src/app/services/project.service.ts (MODIFIED) ===============
import { Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs'; // Removed 'of' and 'timer' as they are not needed for the actual call
import { catchError, timeout } from 'rxjs/operators'; // Removed 'switchMap'
// Models are imported in their respective files

@Injectable({
  providedIn: 'root'
})
export class ProjectService {
  private apiUrl = 'http://localhost:8081/api/v1/projects';
  private readonly REQUEST_TIMEOUT = 30000;

  constructor(private http: HttpClient) { }

  createProject(projectData: CreateMovieProjectRequest): Observable<MovieProjectResponse> {
    console.log('ProjectService: createProject called with data:', projectData);
    return this.http.post<MovieProjectResponse>(this.apiUrl, projectData)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error('ProjectService: createProject request timed out.');
            return throwError(() => new Error('Request to create project timed out. Please try again.'));
          }
          return this.handleError(err, 'createProject');
        })
      );
  }

  // MODIFIED: This is now the actual HTTP GET call
  getProjectById(projectId: number): Observable<MovieProjectResponse> {
    console.log(`ProjectService: getProjectById called for projectId: ${projectId}. Attempting REAL API call.`);
    return this.http.get<MovieProjectResponse>(`${this.apiUrl}/${projectId}`)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error(`ProjectService: getProjectById request for ${projectId} timed out.`);
            return throwError(() => new Error(`Request to get project ${projectId} timed out.`));
          }
          return this.handleError(err, `getProjectById(${projectId})`);
        })
      );
  }

  private handleError(error: HttpErrorResponse, operation: string = 'operation') {
    let errorMessage = `An unknown error occurred during ${operation}!`;
     if (error.status === 0) {
        errorMessage = `Network error or CORS issue during ${operation}. Could not connect to the backend or request was blocked. Please check backend server and CORS configuration.`;
    } else if (error.error instanceof ErrorEvent) {
      errorMessage = `Client-side/Network error during ${operation}: ${error.error.message}`;
    } else {
      errorMessage = `Backend error during ${operation}. Code: ${error.status}, Message: "${error.message || error.statusText || 'Server error'}"`;
      if (error.error && typeof error.error === 'object' && error.error.message) {
         errorMessage += ` Details: ${error.error.message}`;
      } else if (typeof error.error === 'string' && error.error.length < 200 && error.error.length > 0) {
         errorMessage += ` Server Error: ${error.error}`;
      }
    }
    console.error(`ProjectService Error: ${operation} failed (full details):`, { message: errorMessage, errorObj: error });
    return throwError(() => new Error(errorMessage));
  }
}


// =============== src/app/services/team-member.service.ts ===============
// (No changes from previous version, assumed to be correctly calling backend team member endpoints)
import { Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { catchError, timeout } from 'rxjs/operators';
// Models are imported in their respective files

@Injectable({
  providedIn: 'root'
})
export class TeamMemberService {
  private apiUrl = 'http://localhost:8081/api/v1';
  private readonly REQUEST_TIMEOUT = 30000;

  constructor(private http: HttpClient) { }

  getTeamMembers(projectId: number): Observable<TeamMemberDto[]> {
    console.log(`TeamMemberService: getTeamMembers called for projectId: ${projectId}`);
    return this.http.get<TeamMemberDto[]>(`${this.apiUrl}/projects/${projectId}/team-members`)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error(`TeamMemberService: getTeamMembers for project ${projectId} timed out.`);
            return throwError(() => new Error(`Request to get team members for project ${projectId} timed out.`));
          }
          return this.handleError(err, `getTeamMembers(project ${projectId})`);
        })
      );
  }

  addTeamMember(projectId: number, memberData: CreateTeamMemberRequestDto): Observable<TeamMemberDto> {
    console.log(`TeamMemberService: addTeamMember called for projectId: ${projectId} with data:`, memberData);
    const dataToSend = { ...memberData, projectId };
    return this.http.post<TeamMemberDto>(`${this.apiUrl}/projects/${projectId}/team-members`, dataToSend)
      .pipe(
        timeout(this.REQUEST_TIMEOUT),
        catchError(err => {
          if (err.name === 'TimeoutError') {
            console.error(`TeamMemberService: addTeamMember for project ${projectId} timed out.`);
            return throwError(() => new Error(`Request to add team member for project ${projectId} timed out.`));
          }
          return this.handleError(err, `addTeamMember(project ${projectId})`);
        })
      );
  }

  private handleError(error: HttpErrorResponse, operation: string = 'operation') {
    let errorMessage = `An unknown error occurred during ${operation}!`;
    if (error.status === 0) {
        errorMessage = `Network error or CORS issue during ${operation}. Could not connect to the backend or request was blocked. Please check backend server and CORS configuration.`;
    } else if (error.error instanceof ErrorEvent) {
      errorMessage = `Client-side/Network error during ${operation}: ${error.error.message}`;
    } else {
      errorMessage = `Backend error during ${operation}. Code: ${error.status}, Message: "${error.message || error.statusText}"`;
      if (error.error && typeof error.error === 'object' && error.error.message) {
         errorMessage += ` Details: ${error.error.message}`;
      } else if (typeof error.error === 'string' && error.error.length < 200 && error.error.length > 0) {
         errorMessage += ` Server Error: ${error.error}`;
      }
    }
    console.error(`TeamMemberService Error: ${operation} failed (full details):`, { message: errorMessage, errorObj: error });
    return throwError(() => new Error(errorMessage));
  }
}


// =============== src/app/budget-management/budget-management.component.ts (MODIFIED) ===============
// (Reverted to fetch project details)
import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { BudgetDto } from '../models/budget.model';
import { MovieProjectResponse } from '../models/project.model'; // RE-ADDED
import { ProjectService } from '../services/project.service'; // RE-ADDED
import { BudgetService } from '../services/budget.service';
import { finalize } from 'rxjs/operators';

@Component({
  selector: 'app-budget-management',
  templateUrl: './budget-management.component.html',
  styleUrls: ['./budget-management.component.css']
})
export class BudgetManagementComponent implements OnInit {
  movieProjectId: number | null = null;
  project: MovieProjectResponse | null = null; // RE-ADDED

  budgetExists: boolean = false;
  showBudgetForm = false;
  existingBudgetId: number | null = null;
  isLoading = true;
  errorMessage: string | null = null;

  constructor(
    private route: ActivatedRoute,
    private router: Router,
    private projectService: ProjectService, // RE-ADDED
    private budgetService: BudgetService
  ) {}

  ngOnInit(): void {
    console.log("BudgetManagementComponent: ngOnInit - Initializing.");
    const idParam = this.route.snapshot.paramMap.get('projectId');
    console.log("BudgetManagementComponent: ngOnInit - projectId from route:", idParam);
    if (idParam) {
      this.movieProjectId = +idParam;
      this.loadProjectAndThenBudgetDetails(this.movieProjectId);
    } else {
      this.errorMessage = "No project ID provided in the URL. Cannot manage budget.";
      console.error(this.errorMessage);
      this.isLoading = false;
    }
  }

  loadProjectAndThenBudgetDetails(projectId: number): void {
    this.isLoading = true;
    this.errorMessage = null;
    this.project = null;
    this.budgetExists = false;
    this.existingBudgetId = null;
    console.log(`BudgetManagementComponent: loadProjectAndThenBudgetDetails for projectId: ${projectId}`);

    this.projectService.getProjectById(projectId).subscribe({
      next: (projectDetails) => {
        console.log("BudgetManagementComponent: Project details received", projectDetails);
        this.project = projectDetails;
        this.checkExistingBudget(projectId);
      },
      error: (err) => {
        console.error("BudgetManagementComponent: Error loading project details", err);
        this.errorMessage = err.message || `Failed to load project details for ID ${projectId}.`;
        // Create a fallback project object for display if project details fail
        this.project = { id: projectId, title: `Project ${projectId} (Details Unavailable)` } as MovieProjectResponse;
        this.checkExistingBudget(projectId); // Still try to load budget info
      }
    });
  }

  checkExistingBudget(projectId: number): void {
    console.log(`BudgetManagementComponent: checkExistingBudget for projectId: ${projectId}.`);
    // isLoading is true from loadProjectAndThenBudgetDetails.
    // The finalize in this subscription will handle setting isLoading to false overall.
    this.budgetService.getBudgetByMovieProjectId(projectId).pipe(
        finalize(() => {
            console.log(`BudgetManagementComponent: getBudgetByMovieProjectId finalized. Setting isLoading to false.`);
            this.isLoading = false;
        })
    ).subscribe({
      next: budget => {
        console.log("BudgetManagementComponent: Existing budget check response", budget);
        if (budget) {
          this.existingBudgetId = budget.id;
          this.budgetExists = true;
          this.showBudgetForm = false;
        } else {
          this.existingBudgetId = null;
          this.budgetExists = false;
        }
      },
      error: err => {
        console.error("BudgetManagementComponent: Error checking existing budget", err);
        // Append to existing error message if project details also failed
        const budgetErrorMsg = err.message || `Could not verify existing budget.`;
        this.errorMessage = this.errorMessage ? `${this.errorMessage} Additionally, ${budgetErrorMsg}` : budgetErrorMsg;
        this.budgetExists = false;
        this.existingBudgetId = null;
      },
      complete: () => {
        console.log("BudgetManagementComponent: getBudgetByMovieProjectId subscription completed.");
      }
    });
  }

  onBudgetCreated(createdBudget: BudgetDto): void {
    console.log("BudgetManagementComponent: onBudgetCreated", createdBudget);
    this.budgetExists = true;
    this.existingBudgetId = createdBudget.id;
    this.showBudgetForm = false;
    this.errorMessage = null;
    this.router.navigate(['/budgets', createdBudget.id]);
  }

   onBudgetCreationError(errorMessage: string): void {
    console.warn("BudgetManagementComponent received budgetCreationError:", errorMessage);
  }

  initiateCreateBudget(): void {
    console.log("BudgetManagementComponent: initiateCreateBudget called.");
    this.showBudgetForm = true;
    this.errorMessage = null;
  }

  viewExistingBudget(): void {
    console.log("BudgetManagementComponent: viewExistingBudget called for budgetId:", this.existingBudgetId);
    if (this.existingBudgetId) {
      this.router.navigate(['/budgets', this.existingBudgetId]);
    } else {
        this.errorMessage = "Cannot view budget: Budget ID is not available or budget does not exist.";
    }
  }

  cancelCreation(): void {
    console.log("BudgetManagementComponent: cancelCreation called.");
    this.showBudgetForm = false;
  }
}

// =============== src/app/budget-management/budget-management.component.html (MODIFIED) ===============
// (Reverted to use project.title)
// Content for src/app/budget-management/budget-management.component.html
/*
<div class="container mt-4">
  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading details for {{ project?.title || ('Project ID: ' + movieProjectId) }}...</p>
  </div>

  <div *ngIf="errorMessage && !isLoading" class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Error:</strong> {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = null" aria-label="Close"></button>
  </div>

  <div *ngIf="!isLoading && movieProjectId">
    <h2 class="mb-4">
      <i class="bi bi-briefcase-fill me-2"></i>Budget Management for: {{ project?.title || ('Project ID: ' + movieProjectId) }}
    </h2>

    <div *ngIf="showBudgetForm">
      <app-budget-form
        [movieProjectId]="movieProjectId"
        (budgetCreated)="onBudgetCreated($event)"
        (budgetCreationError)="onBudgetCreationError($event)">
      </app-budget-form>
      <button class="btn btn-outline-secondary mt-3" (click)="cancelCreation()">
        <i class="bi bi-x-circle me-1"></i> Cancel Creation
      </button>
    </div>

    <div *ngIf="!showBudgetForm">
      <div *ngIf="budgetExists" class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title text-success">
              <i class="bi bi-check-circle-fill me-2"></i>Budget Found
          </h5>
          <p class="card-text">
            A budget (ID: {{ existingBudgetId }}) already exists for this project.
          </p>
          <button class="btn btn-primary me-2" (click)="viewExistingBudget()" [disabled]="!existingBudgetId">
            <i class="bi bi-eye me-1"></i> View/Edit Budget Details
          </button>
          <button class="btn btn-outline-warning" (click)="initiateCreateBudget()">
            <i class="bi bi-pencil-square me-1"></i> Create New Budget (Will error if one exists)
          </button>
           <p class="small text-muted mt-2">Note: Your backend currently prevents creating a new budget if one already exists for the project.</p>
        </div>
      </div>

      <div *ngIf="!budgetExists" class="card shadow-sm mb-3">
         <div class="card-body">
          <h5 class="card-title text-info">
              <i class="bi bi-info-circle-fill me-2"></i>No Budget Yet
          </h5>
          <p class="card-text">
            No budget has been created for this project yet.
          </p>
          <button class="btn btn-success" (click)="initiateCreateBudget()">
            <i class="bi bi-plus-circle me-1"></i> Create New Budget
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && !movieProjectId && !errorMessage" class="alert alert-warning">
    Project ID not available. Please ensure you have navigated from a project.
    <a routerLink="/" class="btn btn-link">Go to Project Selection</a>
  </div>
</div>
*/

// =============== src/app/team-management/team-management.component.ts (MODIFIED) ===============
// (Reverted to fetch project details)
import { Component, OnInit } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { TeamMemberService } from '../services/team-member.service';
import { ProjectService } from '../services/project.service'; // RE-ADDED
import { TeamMemberDto } from '../models/team.model';
import { MovieProjectResponse } from '../models/project.model'; // RE-ADDED
import { finalize } from 'rxjs/operators';

@Component({
  selector: 'app-team-management',
  templateUrl: './team-management.component.html',
  styleUrls: ['./team-management.component.css']
})
export class TeamManagementComponent implements OnInit {
  projectId!: number;
  project: MovieProjectResponse | null = null; // RE-ADDED

  teamMembers: TeamMemberDto[] = [];
  isLoading = true;
  errorMessage: string | null = null;
  showAddTeamMemberForm = false;

  constructor(
    private route: ActivatedRoute,
    private teamMemberService: TeamMemberService,
    private projectService: ProjectService // RE-ADDED
  ) {}

  ngOnInit(): void {
    console.log("TeamManagementComponent: ngOnInit - Initializing.");
    const idParam = this.route.snapshot.paramMap.get('projectId');
    if (idParam) {
      this.projectId = +idParam;
      console.log("TeamManagementComponent: projectId from route:", this.projectId);
      this.loadProjectDetailsAndThenTeamMembers();
    } else {
      this.errorMessage = "Project ID not found in URL. Cannot manage team.";
      this.isLoading = false;
      console.error("TeamManagementComponent: Project ID missing.");
    }
  }

  loadProjectDetailsAndThenTeamMembers(): void {
    this.isLoading = true;
    this.errorMessage = null;
    this.project = null;
    console.log(`TeamManagementComponent: loadProjectDetailsAndThenTeamMembers for projectId: ${this.projectId}`);

    this.projectService.getProjectById(this.projectId).subscribe({
        next: (projectDetails) => {
            console.log("TeamManagementComponent: Project details loaded", projectDetails);
            this.project = projectDetails;
            this.loadTeamMembers(); // Now load team members
        },
        error: (err) => {
            console.error("TeamManagementComponent: Error loading project details", err);
            this.errorMessage = err.message || `Failed to load project details for ID ${this.projectId}.`;
            this.project = { id: this.projectId, title: `Project ${this.projectId} (Details Unavailable)` } as MovieProjectResponse; // Fallback
            this.loadTeamMembers(); // Still attempt to load team members
        }
    });
  }

  loadTeamMembers(): void {
    console.log(`TeamManagementComponent: loadTeamMembers for projectId: ${this.projectId}`);
    this.teamMemberService.getTeamMembers(this.projectId).pipe(
      finalize(() => {
        console.log("TeamManagementComponent: loadTeamMembers finalized.");
        this.isLoading = false;
      })
    ).subscribe({
      next: (members) => {
        console.log("TeamManagementComponent: Team members loaded", members);
        this.teamMembers = members;
      },
      error: (err) => {
        console.error("TeamManagementComponent: Error loading team members", err);
        const teamErrorMsg = err.message || `Failed to load team members.`;
        this.errorMessage = this.errorMessage ? `${this.errorMessage} Additionally, ${teamErrorMsg}` : teamErrorMsg;
        this.teamMembers = [];
      }
    });
  }

  onTeamMemberSaved(newMember: TeamMemberDto): void {
    console.log("TeamManagementComponent: onTeamMemberSaved, new member:", newMember);
    this.showAddTeamMemberForm = false;
    this.loadTeamMembers();
  }

  toggleAddTeamMemberForm(): void {
    this.showAddTeamMemberForm = !this.showAddTeamMemberForm;
    if (this.showAddTeamMemberForm) {
      this.errorMessage = null;
    }
  }
}

// =============== src/app/team-management/team-management.component.html (MODIFIED) ===============
// (Reverted to use project.title)
// Content for src/app/team-management/team-management.component.html
/*
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      <i class="bi bi-people-fill me-2"></i>Team Management for {{ project?.title || ('Project ID: ' + projectId) }}
    </h2>
    <button class="btn btn-primary" (click)="toggleAddTeamMemberForm()">
      <i class="bi bi-plus-circle me-1"></i> {{ showAddTeamMemberForm ? 'Hide Form' : 'Add Team Member' }}
    </button>
  </div>

  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading details for {{ project?.title || ('Project ID: ' + projectId) }}...</p>
  </div>

  <div *ngIf="errorMessage && !isLoading" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <app-team-member-form
    *ngIf="showAddTeamMemberForm && projectId"
    [projectId]="projectId"
    (teamMemberSaved)="onTeamMemberSaved($event)"
    (cancelForm)="toggleAddTeamMemberForm()">
  </app-team-member-form>

  <div *ngIf="!isLoading && !showAddTeamMemberForm">
    <div *ngIf="teamMembers.length > 0; else noTeamMembers" class="list-group shadow-sm">
      <div *ngFor="let member of teamMembers" class="list-group-item list-group-item-action flex-column align-items-start mb-2 border">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{ member.name }} <span class="badge bg-info ms-2">{{ member.type }}</span></h5>
          <small class="text-muted">ID: {{ member.id }}</small>
        </div>
        <p class="mb-1"><strong>Role:</strong> {{ member.role }}</p>
        <p class="mb-1"><strong>Contact:</strong> {{ member.contactInfo }}</p>
        <p *ngIf="member.type === 'CREW' && member.department" class="mb-1"><strong>Department:</strong> {{ member.department }}</p>
        <p *ngIf="member.type === 'CAST' && member.agentInfo" class="mb-1"><strong>Agent:</strong> {{ member.agentInfo }}</p>
        <div *ngIf="member.contractDetails" class="mt-2">
            <h6>Contract Info (Simplified):</h6>
            <pre class="bg-light p-2 rounded small">{{ member.contractDetails }}</pre>
        </div>
        <div *ngIf="member.availabilityNotes" class="mt-2">
            <h6>Availability (Simplified):</h6>
            <pre class="bg-light p-2 rounded small">{{ member.availabilityNotes }}</pre>
        </div>
        <small class="text-muted">Added: {{ member.createdAt | date:'short' }} | Updated: {{ member.updatedAt | date:'short' }}</small>
      </div>
    </div>
    <ng-template #noTeamMembers>
      <div *ngIf="!errorMessage" class="alert alert-info">No team members found for this project yet.</div>
    </ng-template>
  </div>
</div>
*/

// Other files (budget-detail, team-member-form, app.module, app-routing, app.component etc.) remain as per the previous "US03 - Team Management" artifact.
// Ensure all model files (project.model.ts, budget.model.ts, team.model.ts) are correctly defined.
// The ProjectFormComponent and BudgetFormComponent should be fine as they were.
